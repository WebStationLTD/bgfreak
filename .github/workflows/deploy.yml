name: Deploy Node.js App to cPanel (Passenger)

# –ö–æ–≥–∞ –¥–∞ —Å–µ –∏–∑–ø—ä–ª–Ω—è–≤–∞
on:
  push:
    branches: [master]
  # –ü–æ–∑–≤–æ–ª—è–≤–∞ —Ä—ä—á–Ω–æ –ø—É—Å–∫–∞–Ω–µ –æ—Ç GitHub UI
  workflow_dispatch:
  # –ü–æ–∑–≤–æ–ª—è–≤–∞ –ø—É—Å–∫–∞–Ω–µ –æ—Ç WordPress webhook
  repository_dispatch:
    types: [product-update]
  # ‚è∞ SCHEDULED DEPLOY: –í—Å—è–∫–∞ –Ω–æ—â –≤ 03:00 –±—ä–ª–≥–∞—Ä—Å–∫–æ –≤—Ä–µ–º–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)
  # –° ISR –Ω–µ –µ —Ç–æ–ª–∫–æ–≤–∞ –Ω—É–∂–Ω–æ, –Ω–æ –º–æ–∂–µ –¥–∞ –ø–æ–º–∞–≥–∞ –∑–∞ cache refresh
  schedule:
    - cron: "0 1 * * *" # 01:00 UTC = 03:00 Bulgarian Winter Time (UTC+2)

# üö® –í–ê–ñ–ù–û: Cancel –ø—Ä–µ–¥–∏—à–Ω–∏ deploy-–∏ –∫–æ–≥–∞—Ç–æ —Å–µ –ø—É—Å–Ω–µ –Ω–æ–≤
concurrency:
  group: deploy-to-cpanel
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # 15 –º–∏–Ω—É—Ç–∏ (–≤–º–µ—Å—Ç–æ 120!)

    steps:
      # 1. –ò–∑—Ç–µ–≥–ª–∏ –∫–æ–¥–∞ –æ—Ç GitHub
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. –ù–∞—Å—Ç—Ä–æ–π Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      # 3. –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–π dependencies
      - name: Install dependencies
        run: npm ci

      # 4. Build –∑–∞ Node.js (–Ω–µ generate!)
      - name: Build Node.js application
        env:
          GQL_HOST: https://admin.bgfreak.store/graphql
          FRONT_END_URL: https://bgfreak.store
          NODE_ENV: production
        run: npm run build

      # 4.5. –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ package.json –≤ .output –∑–∞ Passenger
      - name: Create package.json for Passenger
        run: |
          cat > .output/package.json << 'EOF'
          {
            "name": "bgfreak-app",
            "version": "1.0.0",
            "type": "module",
            "scripts": {
              "start": "node server/index.mjs"
            },
            "engines": {
              "node": ">=18.0.0"
            },
            "dependencies": {}
          }
          EOF
          echo "‚úÖ Created package.json in .output/"
          cat .output/package.json

      # 5. Deploy .output –∫—ä–º cPanel
      - name: Deploy .output to cPanel
        uses: appleboy/scp-action@v0.1.7
        with:
          host: "101.99.94.10"
          username: "root"
          key: ${{ secrets.VPS_SSH_KEY }}
          port: "20203"
          source: ".output/*"
          target: "/home/bgfreak/bgfreak-app/"
          overwrite: true
          strip_components: 0

      # 6. Deploy package files –∑–∞ production dependencies
      - name: Deploy package files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: "101.99.94.10"
          username: "root"
          key: ${{ secrets.VPS_SSH_KEY }}
          port: "20203"
          source: "package.json,package-lock.json"
          target: "/home/bgfreak/bgfreak-app/"
          overwrite: true

      # 7. Install dependencies –∏ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–π Passenger
      - name: Install dependencies and restart Passenger
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: "101.99.94.10"
          username: "root"
          key: ${{ secrets.VPS_SSH_KEY }}
          port: "20203"
          script: |
            cd /home/bgfreak/bgfreak-app
            
            # Install production dependencies
            npm install --production --no-optional
            
            # Passenger zero-downtime restart
            mkdir -p /home/bgfreak/tmp
            touch /home/bgfreak/tmp/restart.txt
            
            echo "‚úÖ Deployment completed successfully!"
            echo "üîÑ Passenger restarting application..."
            
            # Wait –∑–∞ Passenger –¥–∞ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞
            sleep 5
            
            # Health check
            echo "üè• Health check..."
            curl -I https://bgfreak.store/ || echo "‚ö†Ô∏è Site may take a moment to start"
